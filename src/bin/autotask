#!/usr/bin/env autoscript
#
# Entrypoint for the autoshell.sh task scripting framework.

# TASK_EXECUTION_LOG: Used by all child processes to log which tasks have been
#   executed during this task flow
# TASK_MAIN: name of the main task triggered, some logic should only execute
#   during the main task
export \
    TASK_EXECUTION_LOG \
    TASK_MAIN \
    TASK_NAME \
    TASK_COMPLETION_MARK="#" \
    LOG_CONTEXT_BUILDER="autotask:"

__script_parse_opts() {
    TASK_NAME="${1}"

    declare -g TASK_FILE
    TASK_FILE="$(find_task "${TASK_NAME}")"

    [ -n "${TASK_MAIN-}" ] || \
        TASK_MAIN="${TASK_NAME}"
    [ -n "${TASK_FILE-}" ] || \
        fatal "Task ${TASK_NAME} could not be found in the AUTOSHELL_TASK_PATH"
    [ -n "${TASK_EXECUTION_LOG-}" ] || \
        TASK_EXECUTION_LOG="$(mktemp)"
}

__script_init() {
    include "$(find_lib autotask)"

    [ "${TASK_NAME}" = "${TASK_MAIN}" ] && \
        [ -f "./project.toml" ] && load_toml "./project.toml" "${TASK_USER_CONFIG_PREFIX}"

    if grep -q "^${TASK_NAME}:${TASK_COMPLETION_MARK}" "${TASK_EXECUTION_LOG}"; then
        TASK_SKIP="true"
    fi

    unset -f task.exec task.dependencies task.up_to_date
    include "${TASK_FILE}" || \
        fatal "The task file ${TASK_FILE} is invalid"

    [ "$(type -t task.exec)" = "function" ] || \
        fatal "Task file ${TASK_FILE} is invalid, task.exec() is not defined"

    [ "$(type -t task.dependencies)" = "function" ] && \
        execute_task_dependencies

    task.load_config

    sed -i "/^${TASK_NAME}:/d" "${TASK_EXECUTION_LOG}"
    echo -n "${TASK_NAME}:" >> "${TASK_EXECUTION_LOG}"

    # log INFO "Finished initializing ${TASK_NAME}"
}

__script_exec() {
    # log INFO "executing task ${TASK_NAME}"
    [ "${TASK_SKIP-}" = "true" ] || \
    { [ "$(type -t task.up_to_date)" = "function" ] && task.up_to_date; } || \
        task.exec
}

__script_succeed() {
    echo "${TASK_COMPLETION_MARK}" >> "${TASK_EXECUTION_LOG}"

    if [ "${TASK_NAME}" = "${TASK_MAIN}" ]; then
        local next_task_name
        next_task_name="$(
            grep -v -m1 ".*:${TASK_COMPLETION_MARK}$" "${TASK_EXECUTION_LOG}" | awk -F: '{print $1}'
        )" && \
        [ -n "${next_task_name-}" ] || \
            return 0

        autotask "${next_task_name}"
    fi
}